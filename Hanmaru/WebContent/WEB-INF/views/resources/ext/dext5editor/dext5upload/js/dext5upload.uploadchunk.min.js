importScripts("dext5upload.base64.js");importScripts("dext5upload.xhr.js");var numberOfServerUploadedChunks=0;
function buildFormData(d,n,f,c,h,m,k,l,p,r,q){d=(new FileReaderSync).readAsDataURL(d).match(/,(.*)$/)[1];var a="";if("0"!=h.encryptParam){var g;g=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter);g+="d18"+Dext5Base64._trans_unitAttributeDelimiter+n+Dext5Base64._trans_unitDelimiter;g+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter;g+="d08"+Dext5Base64._trans_unitAttributeDelimiter+c+Dext5Base64._trans_unitDelimiter;
g+="d12"+Dext5Base64._trans_unitAttributeDelimiter+p+Dext5Base64._trans_unitDelimiter;g+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter;g+="d11"+Dext5Base64._trans_unitAttributeDelimiter+h.folderNameRule+Dext5Base64._trans_unitDelimiter;g+="d09"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRule+Dext5Base64._trans_unitDelimiter;g+="d10"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRuleEx+Dext5Base64._trans_unitDelimiter;g+="d35"+Dext5Base64._trans_unitAttributeDelimiter+
h.checkFileExtension+Dext5Base64._trans_unitDelimiter;g+="d37"+Dext5Base64._trans_unitAttributeDelimiter+h.uploadChunkSize+Dext5Base64._trans_unitDelimiter;g+="d47"+Dext5Base64._trans_unitAttributeDelimiter+k+Dext5Base64._trans_unitDelimiter;n=Dext5Base64.makeEncryptParamFinal(h.encryptParam,g);a+="--"+m+'\r\nContent-Disposition: form-data; name="'+n.name+'"';a+="\r\n\r\n";a+=n.value}else a+="--"+m+'\r\nContent-Disposition: form-data; name="dext5CMD"',a+="\r\n",a+="\r\n",a+="uploadRequest",a+="\r\n",
a+="--"+m+'\r\nContent-Disposition: form-data; name="chunkNumber"',a+="\r\n",a+="\r\n",a+=n,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="GUID"',a+="\r\n",a+="\r\n",a+=f,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileName"',a+="\r\n",a+="\r\n",a+=c,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="gpid"',a+="\r\n",a+="\r\n",a+=p,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fidx"',a+="\r\n",a+="\r\n",a+=r,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="folderNameRule"',
a+="\r\n",a+="\r\n",a+=h.folderNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRule"',a+="\r\n",a+="\r\n",a+=h.fileNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRuleEx"',a+="\r\n",a+="\r\n",a+=h.fileNameRuleEx,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cfe"',a+="\r\n",a+="\r\n",a+=h.checkFileExtension,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cs"',a+="\r\n",a+="\r\n",a+=h.uploadChunkSize,a+=
"\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fs"',a+="\r\n",a+="\r\n",a+=k;a+="\r\n";a+="--"+m+'\r\nContent-Disposition: form-data; name="mark"';a+="\r\n";a+="\r\n";a+=l;a+="\r\n";l=q.length;for(n=0;n<l;n++)a+="--"+m+'\r\nContent-Disposition: form-data; name="'+q[n].form_name+'"',a+="\r\n",a+="\r\n",a+=encodeURIComponent(q[n].form_value),a+="\r\n";a+="--"+m+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream; charset=UTF-8";
a+="\r\n";a+="\r\n";a+=d+"\r\n";return a+="--"+m+"--\r\n"}function makeGuidTagName(d){var n=0,f=(new Date).getTime().toString(32),c;for(c=0;5>c;c++)f+=Math.floor(65535*Math.random()).toString(32);return(d||"o_")+f+(n++).toString(32)}
function upload_merge(d,n,f,c,h,m,k,l,p,r,q){var a=XHRFactory.getInstance();a.open("POST",h,m);a.onreadystatechange=function(b){if(4==a.readyState)if(200==a.status){var c=a.responseText;b=c.split("|");1==b.length&&(c=""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(c):Dext5Base64.makeDecryptReponseMessage(c),b=c.split("|"));if(0==c.indexOf("error"))self.postMessage({type:"error",code:b[1],message:b[2],id:d}),XHRFactory.release(a),self.close();else{var e;e=b[0];
var f=e.indexOf("::");-1<f?(c=e.substring(0,f),e=e.substring(f+2)):(c=n,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:d,originalFileName:c,
uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(a)}}else if(400<=a.status&&600>a.status||0==a.status)c=a.responseText,b=c.split("|"),1==b.length&&(c=""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(c):Dext5Base64.makeDecryptReponseMessage(c),b=c.split("|")),
2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:d}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:d}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:d}),XHRFactory.release(a),self.close()};"0"!=k.encryptParam?(h=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"mergeRequest"+Dext5Base64._trans_unitDelimiter),h+="d08"+Dext5Base64._trans_unitAttributeDelimiter+n+Dext5Base64._trans_unitDelimiter,
h+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,h+="d19"+Dext5Base64._trans_unitAttributeDelimiter+c.numberOfChunks+Dext5Base64._trans_unitDelimiter,h+="d12"+Dext5Base64._trans_unitAttributeDelimiter+p+Dext5Base64._trans_unitDelimiter,h+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,h+="d11"+Dext5Base64._trans_unitAttributeDelimiter+k.folderNameRule+Dext5Base64._trans_unitDelimiter,h+="d09"+Dext5Base64._trans_unitAttributeDelimiter+
k.fileNameRule+Dext5Base64._trans_unitDelimiter,h+="d10"+Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(k.encryptParam,h),f=f.name+"="+f.value):(f="dext5CMD=mergeRequest&fileName="+encodeURIComponent(n)+"&GUID="+f+"&numberOfChunks="+c.numberOfChunks+"&gpid="+p+"&fidx="+r,f+="&folderNameRule="+k.folderNameRule+"&fileNameRule="+k.fileNameRule+"&fileNameRuleEx="+k.fileNameRuleEx);"1"==k.integrity&&(f+="&fdi="+k.FDIData);
f+="&mark="+l;l=q.length;for(c=0;c<l;c++)f+="&"+q[c].form_name+"="+encodeURIComponent(q[c].form_value);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{a.send(f)}catch(g){self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:d}),XHRFactory.release(a),self.close()}}
function upload(d,n,f,c,h,m,k,l,p,r,q,a){var g=XHRFactory.getInstance(),b=f,b=-1<b.indexOf("?")?b+"&dext=slice":b+"?dext=slice",b=b+("&p="+makeGuidTagName("urk_"));g.open("POST",b,h);var u=d.size;g.onreadystatechange=function(){if(4==g.readyState)if(200==g.status){var b=g.responseText,d=b.split("|");1==d.length&&(b=""==l.ServerReleaseVer||"2.7.1120889.1613.01">=l.ServerReleaseVer?Dext5Base64.decode(b):Dext5Base64.makeDecryptReponseMessage(b),d=b.split("|"));0==b.indexOf("error")?(self.postMessage({type:"error",
code:d[1],message:d[2],id:m}),XHRFactory.release(g),self.close()):(numberOfServerUploadedChunks++,self.postMessage({type:"progress",uploadedChunks:numberOfServerUploadedChunks,uploadedSize:u,chunkInfo:c,id:m}),numberOfServerUploadedChunks==c.numberOfChunks&&(upload_merge(m,n,k,c,f,h,l,p,r,q,a),numberOfServerUploadedChunks=0),XHRFactory.release(g))}else if(400<=g.status&&600>g.status||0==g.status)b=g.responseText,d=b.split("|"),1==d.length&&(b=""==l.ServerReleaseVer||"2.7.1120889.1613.01">=l.ServerReleaseVer?
Dext5Base64.decode(b):Dext5Base64.makeDecryptReponseMessage(b),d=b.split("|")),2==d.length?self.postMessage({type:"error",code:d[0],message:"Upload Error: "+d[1],id:m}):3==d.length?self.postMessage({type:"error",code:d[1],message:"Upload Error: "+d[2],id:m}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:m}),XHRFactory.release(g),self.close()};b="";if("undefined"==typeof FormData){var e=makeGuidTagName("----dext5_");try{b=buildFormData(d,c.currentNumber,k,n,l,e,
c.size,p,r,q,a)}catch(v){self.postMessage({type:"reupload",chunk:d,filename:n,chunkInfo:c,asyncstate:h,guid:k,configValues:l,id:m,mark:p,gpid:r,fidx:q})}g.setRequestHeader("Content-Type","multipart/form-data; boundary="+e);g.setRequestHeader("Dext5-Encoded","base64")}else{b=new FormData;"0"!=l.encryptParam?(e=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter),e+="d18"+Dext5Base64._trans_unitAttributeDelimiter+c.currentNumber+Dext5Base64._trans_unitDelimiter,
e+="d07"+Dext5Base64._trans_unitAttributeDelimiter+k+Dext5Base64._trans_unitDelimiter,e+="d08"+Dext5Base64._trans_unitAttributeDelimiter+n+Dext5Base64._trans_unitDelimiter,e+="d12"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,e+="d38"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,e+="d11"+Dext5Base64._trans_unitAttributeDelimiter+l.folderNameRule+Dext5Base64._trans_unitDelimiter,e+="d09"+Dext5Base64._trans_unitAttributeDelimiter+l.fileNameRule+
Dext5Base64._trans_unitDelimiter,e+="d10"+Dext5Base64._trans_unitAttributeDelimiter+l.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,e+="d35"+Dext5Base64._trans_unitAttributeDelimiter+l.checkFileExtension+Dext5Base64._trans_unitDelimiter,e+="d37"+Dext5Base64._trans_unitAttributeDelimiter+l.uploadChunkSize+Dext5Base64._trans_unitDelimiter,e+="d47"+Dext5Base64._trans_unitAttributeDelimiter+c.size+Dext5Base64._trans_unitDelimiter,e=Dext5Base64.makeEncryptParamFinal(l.encryptParam,e),b.append(e.name,
e.value)):(b.append("dext5CMD","uploadRequest"),b.append("chunkNumber",c.currentNumber),b.append("GUID",k),b.append("fileName",n),b.append("gpid",r),b.append("fidx",q),b.append("folderNameRule",l.folderNameRule),b.append("fileNameRule",l.fileNameRule),b.append("fileNameRuleEx",l.fileNameRuleEx),b.append("cfe",l.checkFileExtension),b.append("cs",l.uploadChunkSize),b.append("fs",c.size));b.append("mark",p);for(var e=a.length,t=0;t<e;t++)b.append(a[t].form_name,encodeURIComponent(a[t].form_value));b.append("Slice",
d)}try{g.send(b)}catch(w){self.postMessage({type:"reupload",chunk:d,filename:n,chunkInfo:c,asyncstate:h,guid:k,configValues:l,id:m,mark:p,gpid:r,fidx:q}),XHRFactory.release(g)}b=d=null}
function uploadZeroFile(d,n,f,c,h,m,k,l,p,r,q){var a=XHRFactory.getInstance();a.open("POST",c,h);a.onreadystatechange=function(b){if(4==a.readyState)if(200==a.status){var c=a.responseText;b=c.split("|");1==b.length&&(c=""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(c):Dext5Base64.makeDecryptReponseMessage(c),b=c.split("|"));if(0==c.indexOf("error"))self.postMessage({type:"error",code:b[1],message:b[2],id:d}),XHRFactory.release(a),self.close();else{var e;e=b[0];
var f=e.indexOf("::");-1<f?(c=e.substring(0,f),e=e.substring(f+2)):(c=n,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:d,originalFileName:c,
uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:d,originalFileName:c,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(a)}}else if(400<=a.status&&600>a.status||0==a.status)c=a.responseText,b=c.split("|"),1==b.length&&(c=""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(c):Dext5Base64.makeDecryptReponseMessage(c),b=c.split("|")),
2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:d}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:d}):self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:d}),XHRFactory.release(a),self.close()};"0"!=k.encryptParam?(c=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uzr"+Dext5Base64._trans_unitDelimiter),c+="d08"+Dext5Base64._trans_unitAttributeDelimiter+n+Dext5Base64._trans_unitDelimiter,
c+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,c+="d12"+Dext5Base64._trans_unitAttributeDelimiter+p+Dext5Base64._trans_unitDelimiter,c+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,c+="d11"+Dext5Base64._trans_unitAttributeDelimiter+k.folderNameRule+Dext5Base64._trans_unitDelimiter,c+="d09"+Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRule+Dext5Base64._trans_unitDelimiter,c+="d10"+Dext5Base64._trans_unitAttributeDelimiter+
k.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,c+="d35"+Dext5Base64._trans_unitAttributeDelimiter+k.checkFileExtension+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(k.encryptParam,c),f=f.name+"="+f.value):(f="dext5CMD=uzr&fileName="+encodeURIComponent(n)+"&GUID="+f+"&gpid="+p+"&fidx="+r,f+="&folderNameRule="+k.folderNameRule+"&fileNameRule="+k.fileNameRule+"&fileNameRuleEx="+k.fileNameRuleEx,f+="&cfe="+k.checkFileExtension);f+="&mark="+l;l=q.length;for(p=0;p<l;p++)f+="&"+
q[p].form_name+"="+encodeURIComponent(q[p].form_value);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{a.send(f)}catch(g){self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:d}),XHRFactory.release(a),XHRFactory=null,self.close()}}
self.onmessage=function(d){d=d.data;switch(d.type){case "upload":upload(d.chunk,d.filename,d.handlerurl,d.chunkInfo,d.asyncstate,d.id,d.guid,d.configValues,d.mark,d.gpid,d.fidx,d.formDataEx);break;case "uploadZeroFile":self.postMessage({type:"progress",uploadedChunks:1,uploadedSize:0,chunkInfo:{currentNumber:1,numberOfChunks:1,size:0},id:d.id}),uploadZeroFile(d.id,d.filename,d.guid,d.handlerurl,d.asyncstate,d.blob,d.configValues,d.mark,d.gpid,d.fidx,d.formDataEx)}};
